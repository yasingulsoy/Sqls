/* Parametreler:
   :start_dt     = '2025-08-01 00:00:00'
   :end_next_dt  = '2025-09-01 00:00:00'
   :clinic_id    = NULL veya bir şube id'si
*/
SELECT
  COALESCE(pc.pc_name, '—') AS anlasmali_kurum,
  pc.company_type,
  CASE
    WHEN pc.company_type = 1 THEN 'Yurtiçi Kurum'
    WHEN pc.company_type = 2 THEN 'Yurtdışı Kurum'
    WHEN pc.company_type IS NULL THEN 'Kurum Yok'
    ELSE CONCAT('Diğer (', pc.company_type, ')')
  END AS company_type_text,
  COUNT(*) AS cnt,
  ROUND(100.0 * COUNT(*) / NULLIF(t.total_cnt,0), 2) AS pct
FROM patients p
LEFT JOIN partnership_companies pc
       ON pc.id = p.partnership_companies
CROSS JOIN (
  SELECT COUNT(*) AS total_cnt
  FROM patients p2
  WHERE p2.isDeleted = 0
    AND p2.saved_on >= :start_dt
    AND p2.saved_on <  :end_next_dt
    AND (:clinic_id IS NULL OR p2.clinic_id = :clinic_id)
) t
WHERE p.isDeleted = 0
  AND p.saved_on >= :start_dt
  AND p.saved_on <  :end_next_dt
  AND (:clinic_id IS NULL OR p.clinic_id = :clinic_id)
GROUP BY anlasmali_kurum, pc.company_type, company_type_text
ORDER BY cnt DESC, anlasmali_kurum;
